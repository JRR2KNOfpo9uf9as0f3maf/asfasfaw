local base64_chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/'

local function base64_encode(data)
    return ((data:gsub('.', function(x)
        local r, b = '', x:byte()
        for i = 8, 1, -1 do r = r .. (b % 2 ^ i - b % 2 ^ (i - 1) > 0 and '1' or '0') end
        return r
    end) .. '0000'):gsub('%d%d%d?%d?%d?%d?', function(x)
        if (#x < 6) then return '' end
        local c = 0
        for i = 1, 6 do c = c + (x:sub(i, i) == '1' and 2 ^ (6 - i) or 0) end
        return base64_chars:sub(c + 1, c + 1)
    end) .. ({ '', '==', '=' })[#data % 3 + 1])
end

-- XOR tanpa bit32 (Berfungsi di Lua 5.3+)
local function xor_encrypt(input, key)
    local output = {}
    for i = 1, #input do
        local xor_val = (input:byte(i) ~ key) % 256
        output[i] = string.char(xor_val)
    end
    return table.concat(output)
end

local function obfuscate(file)
    local f = io.open(file, "r")
    if not f then
        print("File tidak ditemukan!")
        return
    end

    local code = f:read("*a") -- Baca kode asli
    f:close()

    local key = math.random(1, 255) -- Kunci XOR (acak setiap kali encrypt)
    local encrypted_code = xor_encrypt(code, key) -- XOR Enkripsi
    local encoded = base64_encode(encrypted_code) -- Base64 Encode

    -- Simpan ke file baru
    local output = "encrypted_" .. file
    local f_out = io.open(output, "w")
    
    -- Kode langsung terenkripsi tanpa fungsi tambahan
    f_out:write("load((function() local a,b='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/','")
    f_out:write(encoded)
    f_out:write("',c,d,e={}," .. key .. ",'' for f=1,#b do c[b:sub(f,f)]=f-1 end for f=1,#b do d=f%4==1 and c[b:sub(f,f)]*64 or d+(f%4==2 and c[b:sub(f,f)]*16 or f%4==3 and c[b:sub(f,f)]*4 or c[b:sub(f,f)]//16) if f%4==0 then e=e..string.char((d-d%256)/256,d%256) end end return (e:gsub('.', function(g) return string.char(g:byte() ~ " .. key .. ") end)) end)())")

    f_out:close()
    print("Obfuscation selesai! File disimpan sebagai: " .. output)
end

-- Masukkan nama file yang ingin dienkripsi
obfuscate("CRUS4DER DF 0.1.lua.txt")
