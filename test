local base64_chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/'

local function base64_encode(data)
    return ((data:gsub('.', function(x)
        local r, b = '', x:byte()
        for i = 8, 1, -1 do r = r .. (b % 2 ^ i - b % 2 ^ (i - 1) > 0 and '1' or '0') end
        return r
    end) .. '0000'):gsub('%d%d%d?%d?%d?%d?', function(x)
        if (#x < 6) then return '' end
        local c = 0
        for i = 1, 6 do c = c + (x:sub(i, i) == '1' and 2 ^ (6 - i) or 0) end
        return base64_chars:sub(c + 1, c + 1)
    end) .. ({ '', '==', '=' })[#data % 3 + 1])
end

-- XOR tanpa bit32 (Berfungsi di Lua 5.3+)
local function xor_encrypt(input, key)
    local output = {}
    for i = 1, #input do
        local xor_val = (input:byte(i) ~ key) % 256
        output[i] = string.char(xor_val)
    end
    return table.concat(output)
end

local function obfuscate(file)
    local f = io.open(file, "r")
    if not f then
        print("File tidak ditemukan!")
        return
    end

    local code = f:read("*a") -- Baca kode asli
    f:close()

    local key = math.random(1, 255) -- Kunci XOR (acak setiap kali encrypt)
    local encrypted_code = xor_encrypt(code, key) -- XOR Enkripsi
    local encoded = base64_encode(encrypted_code) -- Base64 Encode

    -- Simpan ke file baru
    local output = "encrypted_" .. file
    local f_out = io.open(output, "w")
    
    -- Kode langsung terenkripsi tanpa fungsi tambahan
    f_out:write(string.format([[
load((function() 
    local base64_chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/'
    local encoded_data = "%s"
    local key = %d
    local decode_map, decoded_str, buffer = {}, '', ''

    for i = 1, #base64_chars do decode_map[base64_chars:sub(i, i)] = i - 1 end
    for i = 1, #encoded_data do
        local char = encoded_data:sub(i, i)
        buffer = buffer .. (decode_map[char] and string.format('%06d', tonumber(tostring(decode_map[char]), 2)) or '')
    end
    for i = 1, #buffer, 8 do
        local byte = tonumber(buffer:sub(i, i + 7), 2)
        decoded_str = decoded_str .. string.char(byte ~ key)
    end
    return decoded_str
end)()) ]], encoded, key))

    f_out:close()
    print("Obfuscation selesai! File disimpan sebagai: " .. output)
end

-- Masukkan nama file yang ingin dienkripsi
obfuscate("CRUS4DER DF 0.1.lua.txt")
